<!DOCTYPE html>
<html>
<head>
  <title>Worker</title>
  <script>
    let isRunning = true;
    let config = {};
    let retryCount = 0;
    
    window.addEventListener('message', (e) => {
      if (e.data.type === 'CONFIG') {
        config = e.data.config;
        startSending();
      } else if (e.data.type === 'STOP') {
        isRunning = false;
        parent.postMessage({
          type: 'LOG',
          message: 'تم إيقاف الإرسال',
          level: 'warning'
        }, '*');
      }
    });
    
    async function sendMessage() {
      try {
        const response = await fetch(
          `https://discord.com/api/v9/channels/${config.channelId}/messages`,
          {
            method: 'POST',
            headers: {
              'Authorization': config.token,
              'Content-Type': 'application/json',
              'User-Agent': 'Mozilla/5.0'
            },
            body: JSON.stringify({
              content: config.message
            })
          }
        );
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || `HTTP ${response.status}`);
        }
        
        retryCount = 0;
        return data;
      } catch (error) {
        retryCount++;
        if (retryCount <= config.retries) {
          parent.postMessage({
            type: 'LOG',
            message: `محاولة ${retryCount} من ${config.retries}...`,
            level: 'warning'
          }, '*');
          await new Promise(r => setTimeout(r, 1000));
          return sendMessage();
        }
        throw error;
      }
    }
    
    async function startSending() {
      while (isRunning) {
        try {
          const data = await sendMessage();
          
          parent.postMessage({
            type: 'LOG',
            message: 'تم إرسال الرسالة بنجاح',
            level: 'success',
            data: data
          }, '*');
        } catch (error) {
          parent.postMessage({
            type: 'LOG',
            message: `فشل الإرسال: ${error.message}`,
            level: 'error'
          }, '*');
        }
        
        await new Promise(r => setTimeout(r, config.delay));
      }
    }
    
    // إبقاء النافذة نشطة
    setInterval(() => {
      try {
        parent.postMessage({ type: 'PING' }, '*');
      } catch (e) {
        console.log('فقدان الاتصال بالنافذة الرئيسية');
      }
    }, 30000);
  </script>
</head>
<body style="display:none">
  <!-- نافذة خفية -->
</body>
</html>
